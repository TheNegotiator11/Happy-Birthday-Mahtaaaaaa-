<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blow the Candle ‚Äî Mahta</title>
<style>
body {
  text-align:center;
  font-family:Arial, Helvetica, sans-serif;
  background:linear-gradient(90deg,#ffdde1,#ee9ca7);
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
h1 { color:#fff; text-shadow:2px 2px #444; margin-top:20px; }
#status { margin-top:10px; color:#fff; }
#cake-container { position:relative; margin-top:20px; width: 280px; max-width:90vw; }
#cake { width:100%; height:auto; display:block; }
.candle {
  position:absolute;
  width:20px;
  height:60px;
  background:#fff;
  border-radius:4px;
  left:50%;
  transform:translateX(-50%);
  cursor:pointer;
}
.flame {
  position:absolute;
  top:-20px;
  left:0;
  width:20px;
  height:20px;
  border-radius:50%;
  background:radial-gradient(circle at center, yellow 40%, orange 70%, transparent 100%);
  animation:flicker .18s infinite alternate;
}
@keyframes flicker {
  from{transform:scale(1) translateY(0)} 
  to{transform:scale(1.15) translateY(-2px)}
}
#message { display:none; margin-top:18px; font-size:1.2rem; color:#fff; }
.home-btn { margin-top:12px; padding:8px 14px; border-radius:8px; border:none; background:#ff66b2; color:#fff; cursor:pointer; font-weight:700; }
canvas { position:fixed; top:0; left:0; pointer-events:none; z-index:999; }
</style>
</head>
<body>
<h1>üéÇ Blow the Candle, Mahta!</h1>
<div id="status">Blow into the mic or tap the candle to blow it out!</div>

<div id="cake-container">
  <img id="cake" src="cake.png" alt="Cake" />
  <div class="candle" id="candle">
    <div class="flame"></div>
  </div>
</div>

<div id="message">üéâ The candle is out! Happy 17th Birthday, Mahta! üéâ</div>
<button class="home-btn" onclick="location.href='index.html'">üè† Back to Home</button>
<canvas id="confetti"></canvas>

<script>
const candle = document.getElementById('candle');
const flame = candle.querySelector('.flame');
const message = document.getElementById('message');
const confCanvas = document.getElementById('confetti');
const confCtx = confCanvas.getContext('2d');

// Position candle dynamically at 2/5 from top of the cake
const cakeImg = document.getElementById('cake');
function positionCandle() {
  const y = cakeImg.height * 0.4 - candle.offsetHeight; // 2/5 from top
  candle.style.top = y + 'px';
}
cakeImg.onload = positionCandle;
window.addEventListener('resize', positionCandle);

// Blow out candle function
function blowOut() {
  if(flame){ flame.remove(); }
  message.style.display='block';
  startConfettiShort(3000);
}

// Optional tap to blow out
candle.addEventListener('click', blowOut);

// Confetti function
function resizeConf(){ confCanvas.width=innerWidth; confCanvas.height=innerHeight; }
addEventListener('resize', resizeConf); resizeConf();
function startConfettiShort(ms){
  let pieces=[];
  for(let i=0;i<200;i++){
    pieces.push({x:Math.random()*confCanvas.width, y:-Math.random()*confCanvas.height, s:Math.random()*8+4, c:`hsl(${Math.random()*360},100%,50%)`, vx:(Math.random()-0.5)*2, vy:Math.random()*4+2});
  }
  let running=true;
  function step(){
    confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
    pieces.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy;
      confCtx.fillStyle=p.c; confCtx.fillRect(p.x,p.y,p.s,p.s);
    });
    if(running) requestAnimationFrame(step);
  }
  step();
  setTimeout(()=>{ running=false; confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); }, ms);
}

// Microphone detection immediately on load
async function initMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize=2048;
    source.connect(analyser);
    const data = new Uint8Array(analyser.fftSize);
    function detect(){
      analyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){
        const v=(data[i]-128)/128;
        sum+=v*v;
      }
      const rms=Math.sqrt(sum/data.length);
      // threshold to blow candle; prevents multiple triggers
      if(rms>0.08){
        blowOut();
      }
      requestAnimationFrame(detect);
    }
    detect();
  } catch(e){
    document.getElementById('status').textContent='Microphone access blocked ‚Äî tap the candle to blow it out!';
    console.log('Mic not allowed or not available');
  }
}
initMic();
</script>
</body>
</html>
